# 2026-02-14 實作計劃（V1 可落地）

## 1. 範圍與目標
本次 V1 聚焦三個可上線功能：

1. 租貸期間改為月曆模式（Range 選取起訖日）
2. 新增「歸還後清潔時間」並自動標示為不可出租
3. 新增 Host 出租率系統，並在商品詳情頁整合顯示評價與出租率

不在本次範圍：

1. 小時級租借
2. 動態定價
3. 複雜風控策略（先保留基礎日誌）

## 2. 功能規格

### 2.1 月曆租貸模式
1. 使用月曆區間選擇（startDate/endDate）
2. 日期單位以「天」計算
3. 不可選日期包含：
   - 已被預訂區間
   - 清潔保留區間

### 2.2 歸還後清潔時間
1. Host 於商品編輯頁可設定 `歸還後清潔時間（天）`
2. 欄位預設值：`0`
3. 限制範圍：`0 ~ 30`（V1）
4. 計算規則：
   - 已租借至 `end_date`
   - 清潔封鎖為 `end_date + 1` 到 `end_date + cleaning_buffer_days`

### 2.3 出租率系統
1. 初始值：`85%`
2. Host 拒絕一次：`-5%`
3. 成功完成一次：`+2%`
4. 邊界：`0% ~ 100%`
5. 標籤規則：
   - `>95%`：`推薦出租`
   - `=100%`：`極優出租`
6. 移除色階規則：
   - 不使用 `0-70 紅橙`
   - 不使用 `71-95 藍`

### 2.4 商品詳情頁顯示
商品詳情頁需顯示：

1. Host 評價（平均分與筆數）
2. 商品評價（平均分與筆數）
3. Host 出租率（百分比、進度條、標籤）

## 3. 資料庫設計（Drizzle）

### 3.1 `items`（新增）
1. `cleaning_buffer_days int not null default 0`

### 3.2 Host 相關（擇一：`users` 或 `host_profiles`）
1. `rental_rate int not null default 85`
2. `rental_badge varchar(20) not null default 'none'`
3. `rental_rate_updated_at timestamp`

### 3.3 新增日誌表 `host_rental_rate_logs`
1. `id`
2. `host_id`
3. `rental_id`
4. `event_type`（`host_rejected` / `rental_completed`）
5. `delta`
6. `before_rate`
7. `after_rate`
8. `created_at`

## 4. 後端邏輯與 Server Actions

### 4.1 可租區間計算
新增查詢函式：`getItemBlockedDates(itemId, from, to)`

回傳：

1. `bookedRanges`
2. `cleaningRanges`
3. `disabledDates`

僅納入會占用檔期狀態（例如：`host_accepted`, `in_progress`, `completed`）。

### 4.2 下單前二次驗證
在建立交易 action 內：

1. 驗證所選日期是否與 `bookedRanges/cleaningRanges` 重疊
2. 若重疊直接 reject：`所選日期包含已預訂或清潔保留時段`

### 4.3 出租率更新服務
新增 `adjustHostRentalRate(hostId, delta, rentalId, eventType)`：

1. 交易內讀取當前值
2. 計算 `next = clamp(current + delta, 0, 100)`
3. 同步 badge：
   - `next === 100` -> `elite`
   - `next > 95` -> `recommended`
   - else -> `none`
4. 寫入 host 表
5. 寫入 `host_rental_rate_logs`

觸發點：

1. Host 拒絕交易成功後 -> `delta = -5`
2. 交易完成後 -> `delta = +2`

## 5. 前端 UI/UX

### 5.1 商品編輯頁 `/items/[id]/edit`
1. 新增欄位：`歸還後清潔時間（天）`
2. 驗證錯誤訊息（Zod）
3. 儲存成功後即影響檔期計算

### 5.2 商品詳情頁
1. 月曆顯示可租與不可租日期
2. 不可租樣式區分：
   - 已預訂
   - 清潔保留
3. 顯示 Host 評價、商品評價、出租率進度條與標籤

## 6. 驗收測試（V1）

### 6.1 檔期與清潔時間
1. `cleaning_buffer_days=0`：僅封鎖訂單日期
2. `cleaning_buffer_days=2`：歸還後 2 天不可選
3. 月曆上清潔區間不可點選
4. API/Action 二次驗證可阻擋衝突下單

### 6.2 出租率
1. 新 Host 初始 `85%`
2. 拒絕一次 `-5%`
3. 完成一次 `+2%`
4. `>95%` 出現 `推薦出租`
5. `=100%` 出現 `極優出租`
6. 上下界 clamp 正確

### 6.3 商品詳情頁整合
1. Host 評價資料正確
2. 商品評價資料正確
3. 出租率與 badge 即時更新

## 7. 上線分階段

### Sprint 1
1. Schema 變更
2. 可租區間/清潔區間計算
3. 下單二次驗證

### Sprint 2
1. Host 拒絕與完成流程串接出租率
2. 出租率 log 與 badge 規則

### Sprint 3
1. 商品編輯頁清潔天數欄位
2. 商品詳情頁月曆與評價/出租率整合
3. 監控與錯誤追蹤

## 8. 風險與注意事項
1. 併發下單需靠 transaction + 再驗證避免超賣
2. 修改清潔天數後，既有未來檔期需即時重算
3. 狀態機必須定義「哪些狀態占用檔期」避免漏算
4. 出租率只在「狀態成功轉移」時更新，避免重複加減
